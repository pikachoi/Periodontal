{% extends 'Diagnosis_base.html' %}
{% load static %}

<title>LTLUX-P: Single</title>

{% block content %}
<a href="{% url 'login' %}">로그인 화면으로</a>

<h1>Diagnosis</h1>
<form id="upload-form" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="file" id="imgfile" accept="image/*" required>
    <button type="button" onclick="uploadImage()">Upload</button>
</form>

<div id="image-container">
    <canvas id="output-image" width="1024" height="512"></canvas>
</div>

<script>
    function drawPolyline(ctx, points, color, isClosed = false) {
        ctx.beginPath();
        points.forEach((point, index) => {
            if (index === 0) {
                ctx.moveTo(point[0], point[1]);
            } else {
                ctx.lineTo(point[0], point[1]);
            }
        });
        if (isClosed) {
            ctx.closePath();
        }
        ctx.strokeStyle = color;
        ctx.stroke();
    }

    function uploadImage() {
        var form_data = new FormData();
        var file_input = document.getElementById('imgfile');
        var canvas = document.getElementById('output-image');
        var ctx = canvas.getContext('2d');

        form_data.append('imgfile', file_input.files[0]);

        fetch('{% url "diagnosis_home" %}', {
            method: 'POST',
            body: form_data,
            headers: {
                'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            var img = new Image();
            img.onload = function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                // 치아 외곽선 및 축 그리기
                data.tooth_data.forEach(tooth => {
                    tooth.segmentation_points.forEach(segment => {
                        drawPolyline(ctx, segment, 'white', true); // 각 세그먼트를 닫힌 폴리곤으로 그림
                    });

                    if (tooth.axis_line && tooth.axis_line.length > 1) {
                        drawPolyline(ctx, tooth.axis_line, 'cyan'); // 축 선
                    }
                });

                // PBL, CEJ 상단 및 하단 선 그리기
                if (data.pbl_seg) {
                    drawPolyline(ctx, data.pbl_seg, 'red', true); // PBL
                }
                if (data.cej_seg_up) {
                    drawPolyline(ctx, data.cej_seg_up, 'green', true); // CEJ 상단
                }
                if (data.cej_seg_low) {
                    drawPolyline(ctx, data.cej_seg_low, 'blue', true); // CEJ 하단
                }
            };
            img.src = URL.createObjectURL(file_input.files[0]);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('이미지를 처리하는 중 오류가 발생했습니다.');
        });
    }
</script>

{% endblock %}
