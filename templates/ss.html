{% extends 'Diagnosis_base.html' %}
{% load static %}

<title>LTLUX-P: Single</title>

{% block content %} 
<a href="{% url 'login' %}">로그인 화면으로</a>

<h1>Tooth Diagnosis</h1>
<form id="upload-form" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="file" id="imgfile" accept="image/*" required>
    <button type="button" onclick="uploadImage()">Upload</button>
</form>

<div id="image-container">
    <canvas id="output-image" width="1024" height="512"></canvas>
</div>

<script>
    var canvas = document.getElementById('output-image');
    var ctx = canvas.getContext('2d');
    var toothData = null;
    var selectedPoint = null;
    var isDragging = false;
    var prevX = 0;
    var prevY = 0;

    function uploadImage() {
        var form_data = new FormData();
        var file_input = document.getElementById('imgfile');

        form_data.append('imgfile', file_input.files[0]);

        fetch('{% url "diagnosis_home" %}', {
            method: 'POST',
            body: form_data,
            headers: {
                'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            toothData = data.tooth_data;
            redrawImage();
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
        })
        .catch(error => console.error('Error:', error));
    }

    function redrawImage() {
        var img = new Image();
        img.onload = function() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            if (toothData) {
                toothData.forEach(tooth => {
                    tooth.segmentation_points.forEach(segment => {
                        ctx.beginPath();
                        segment.forEach((point, index) => {
                            if (index === 0) {
                                ctx.moveTo(point[0], point[1]);
                            } else {
                                ctx.lineTo(point[0], point[1]);
                            }
                        });
                        ctx.closePath();
                        ctx.strokeStyle = 'white';
                        ctx.stroke();
                    });
                    ctx.beginPath();
                    ctx.moveTo(tooth.axis_line[0][0], tooth.axis_line[0][1]);
                    ctx.lineTo(tooth.axis_line[1][0], tooth.axis_line[1][1]);
                    ctx.strokeStyle = 'cyan';
                    ctx.stroke();
                });
            }
        };
        img.src = URL.createObjectURL(document.getElementById('imgfile').files[0]);
    }

    function handleMouseDown(e) {
        var mouseX = e.pageX - canvas.offsetLeft;
        var mouseY = e.pageY - canvas.offsetTop;

        if (toothData) {
            toothData.forEach(tooth => {
                tooth.segmentation_points.forEach(segment => {
                    segment.forEach(point => {
                        var dist = Math.sqrt(Math.pow(mouseX - point[0], 2) + Math.pow(mouseY - point[1], 2));
                        if (dist < 5) {
                            selectedPoint = point;
                            isDragging = true;
                            prevX = mouseX;
                            prevY = mouseY;
                        }
                    });
                });
            });
        }
    }

    function handleMouseMove(e) {
        if (isDragging && selectedPoint) {
            var mouseX = e.pageX - canvas.offsetLeft;
            var mouseY = e.pageY - canvas.offsetTop;

            var dx = mouseX - prevX;
            var dy = mouseY - prevY;

            selectedPoint[0] += dx;
            selectedPoint[1] += dy;

            redrawImage();

            prevX = mouseX;
            prevY = mouseY;
        }
    }

    function handleMouseUp() {
        isDragging = false;
        selectedPoint = null;
    }
</script>

{% endblock %}
