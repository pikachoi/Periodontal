{% extends 'Diagnosis_base.html' %}
{% load static %}
{% block content %}
<div class="back-container">
    <div class="div-v">
        <div class="cover-box">
            <div class="cover-title1" style="width: 1021px;">
                <div class="cover-title2"></div>
                <div class="cover-title3">INPUT FORM</div>
                <div class="cover-title3" style="width: 65px;">X-RAY</div>
                <div class="cover-title2"></div>
            </div>
            <!-- 뱌경 css 요소들 -->
            <!-- <div class="css-base" style="top: 320px;"><div class="css-light"></div></div>
            <div class="css-base" style="top: 620px;"><div class="css-light"></div></div>

            <div class="css-base css-circle" style="top: 500px;"></div>

            <div class="css-base css-line" style="top: 60px;"></div>
            <div class="css-base css-line" style="top: 460px;"></div>

            <div class="css-base css-dot" style="top: 380px;">
                <div class="css-dot2"></div><div class="css-dot2"></div><div class="css-dot2"></div>
                <div class="css-dot2"></div><div class="css-dot2"></div>
            </div> -->
            <!--------------------------------- 인풋박스 --------------------------------->
            <div class="div-h main-top-container">
                <form class="div-v single-input" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="input-box" style=" border: none;">
                        <input type="file" id="imgfile" accept="image/*" required>
                        <div class="age-label">Img</div> 
                        <label for="imgfile">
                            <img style="width: 15px;" src="{% static 'img/plus.svg'%}">
                        </label> 
                        <input class="new-input" value="" placeholder="" required>
                    </div>
                    <div class="input-box">
                        <div class="age-label">Age</div> 
                        <input class="new-input" value="" placeholder="" type="number" id="ageInput" min="1" step="1" required>
                    </div>
                    <div class="input-box" style="padding: 2px; width: 99%;">
                        <button class="upload-btn" type="button" onclick="uploadImage()">UPLOAD</button>
                    </div>
                </form>
                <div id="preview-container"></div>    
                <div id="loader-box" style="margin-left: 50px;"></div>
                <div style="flex-grow: 1; height: 100%; border-right: solid 1px rgb(55, 88, 107);"></div>
            </div>
            <!--------------------------------- 메인 폼 --------------------------------->
            <div class="main-container" style="width: 1024px; height: 670px;">
                <div id="left-cover"></div>
                <div id="right-cover"></div>
                <div id="left-line"></div>
                <div id="right-line"></div>
                <div id="bottom-line"></div>
                <!-------------- 좌측 사이드 바 -------------->
                <div id="sg-results-control">
                    <div class="control-column" style="border-top: none;">Toggle Annotations</div>
                    <label class="toggle-checkbox">
                        <div class="toggle-point"></div>
                        <div class="toggle-text">All</div>
                        <input type="checkbox" id="toggle-all-checkbox">
                        <div class="custom-checkbox"></div>
                    </label>
                    <label class="toggle-checkbox">
                        <div class="toggle-point"></div>
                        <div class="toggle-text">Mask</div>
                        <input type="checkbox" id="toggle-mask-checkbox">
                        <div class="custom-checkbox"></div>
                    </label>
                    <label class="toggle-checkbox">
                        <div class="toggle-point"></div>
                        <div class="toggle-text">Teeth</div>
                        <input type="checkbox" id="toggle-teeth-checkbox">
                        <div class="custom-checkbox"></div>
                    </label>
                    <label class="toggle-checkbox">
                        <div class="toggle-point"></div>
                        <div class="toggle-text">Axis</div>
                        <input type="checkbox" id="toggle-axis-checkbox">
                        <div class="custom-checkbox"></div>
                    </label>
                    <label class="toggle-checkbox">
                        <div class="toggle-point"></div>
                        <div class="toggle-text">PBL</div>
                        <input type="checkbox" id="toggle-pbl-checkbox">
                        <div class="custom-checkbox"></div>
                    </label>
                    <label class="toggle-checkbox">
                        <div class="toggle-point"></div>
                        <div class="toggle-text">CEJ Up</div>
                        <input type="checkbox" id="toggle-cej-up-checkbox">
                        <div class="custom-checkbox"></div>
                    </label>
                    <label class="toggle-checkbox">
                        <div class="toggle-point"></div>
                        <div class="toggle-text">CEJ Low</div>
                        <input type="checkbox" id="toggle-cej-low-checkbox">
                        <div class="custom-checkbox"></div>
                    </label>
                </div>
                <!-------------- 우측 사이드 바 ------------->
                <div id="sg-results-summary">
                    <!------- 등급 파이차트 ------>
                    <div class="control-column">Grade Distribution</div>
                    <div class="div-v" style="width: 120px;  height: auto;">
                        <canvas style="width: 140px; margin-bottom: 10px;" id="gradeChart"></canvas>
                    </div>
                    <!---- 최대소실 크롭 ---->
                    <div class="cropped-image-form" id="cropped-image-container">
                        <div class="control-column">Max Loss Tooth</div>
                        <img id="cropped-image" src="" alt="Cropped Image" style="margin-top: 5px; max-width: 100%; height: auto; display: none;">
                    </div>
                </div>
                <div class="main-container2">
                    <div id="top-infobox-container"></div>
                    <div class="mask-draw-layer" id="mask-image-container"></div>
                    <div class="mask-draw-layer" id="pbl-image-container"></div>
                    <div class="mask-draw-layer" id="cej-up-image-container"></div>
                    <div class="mask-draw-layer" id="cej-low-image-container"></div>
                    <div class="mask-draw-layer" id="teeth-image-container"></div>
                    <div class="mask-draw-layer" id="axis-image-container"></div>
                        <div id="result-draw-layer"><!-- 서버에서 받은 좌표로 css요소를 그리는 레이어 -->
                            <canvas id="canvas-layer" width="1024px" height="512px"></canvas>
                        </div>
                    <div id="bottom-infobox-container"></div>
                </div>
            </div>
            <!---------------- matin 하단 ---------------->
            <!-- -- 통계 ---->
            <div id="statistics"></div>
            <div id="tagging-btn">Tagging</div>
        </div>
    </div>
</div>

<script>
    var save_img
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('tagging-btn').addEventListener('click', function() {
            // 요소들이 존재하는지 확인하고 값을 읽음
            const smokingElement = document.getElementById('select-smoking');
            const diabetesElement = document.getElementById('select-diabetes');

            // 요소들이 존재하지 않을 경우의 오류 처리
            if (!smokingElement || !diabetesElement) {
                alert('옵션을 선택할 수 없습니다. 페이지를 다시 로드해주세요.');
                return;
            }

            // 선택된 옵션 값을 그대로 가져옴
            const smokingValue = smokingElement.value;
            const diabetesValue = diabetesElement.value;

            const data = {
                patient_age: dentalData.age || null,
                max_loss: dentalData.maxLoss !== 'none' ? dentalData.maxLoss : null,
                avg_loss: dentalData.averageLoss !== 'none' ? dentalData.averageLoss : null,
                total_teeth: dentalData.lossCount !== 'none' ? dentalData.lossCount : null,
                grade_a_count: dentalData.gradeCounts.A !== 'none' ? dentalData.gradeCounts.A : null,
                grade_b_count: dentalData.gradeCounts.B !== 'none' ? dentalData.gradeCounts.B : null,
                grade_c_count: dentalData.gradeCounts.C !== 'none' ? dentalData.gradeCounts.C : null,
                smoking: smokingValue,  // 선택된 흡연 옵션을 그대로 저장
                diabetes: diabetesValue,  // 선택된 당뇨 옵션을 그대로 저장
                visualization_image: save_img,  // 수정된 함수 사용
                title: 'Single'
            };

            fetch("{% url 'save_diagnosis_result' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    alert(`Data saved successfully at ${data.saved_at}`);
                } else {
                    alert("Failed to save data.");
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("An error occurred while saving data.");
            });
        });
    });
</script>

<!---------------------------------선택한 인풋 파일명 표시--------------------------------->
<script>
    // 선택한 인풋 파일명 표시 및 기존 파일 정보 저장
    window.onload = function() {
        var fileInput = document.getElementById('imgfile');
        var fileNameField = document.querySelector('.new-input');

        fileInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                var fileName = this.files[0].name;
                fileNameField.value = fileName; // 파일명을 입력 필드에 표시

                // 미리보기 업데이트
                var reader = new FileReader();
                reader.onload = function(e) {
                    var previewContainer = document.getElementById('preview-container');
                    previewContainer.innerHTML = ''; // 기존 미리보기 제거
                    var img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.width = '240px';
                    img.style.height = '120px';
                    previewContainer.appendChild(img);
                };
                reader.readAsDataURL(fileInput.files[0]);
            }
        });

        // 파일 선택 버튼 클릭 시 초기화 기능 추가
        fileInput.addEventListener('click', function() {
            // 파일 인풋 초기화
            fileInput.value = '';
            fileNameField.value = '';

            // 미리보기 초기화
            var previewContainer = document.getElementById('preview-container');
            previewContainer.innerHTML = '';
        });
    };
</script>

<!------------------------------- 위험인자 옵션 선택 ------------------------------->
<script>
    function updateValue(column, value) {
      document.getElementById(`value-${column}`).innerText = value;
      document.getElementById(`select-${column}`).value = value; // 선택된 값을 업데이트
    }
</script>
<!------------------------------- 결과 요약 ------------------------------->
<script>
    var dentalData = {
        maxLoss: 'none',
        minLoss: 'none',
        totalLosses: 'none',
        lossCount: 'none',
        gradeCounts: { A: 'none', B: 'none', C: 'none' },
        age: 'none',
        averageLoss: 'none',
        updateMetrics: function(item) {
            let ratio = parseFloat(item.ratio);
            if (this.maxLoss === 'none' || this.maxLoss < ratio) {
                this.maxLoss = ratio;
            }
            if (this.minLoss === 'none' || this.minLoss > ratio) {
                this.minLoss = ratio;
            }
            this.totalLosses = this.totalLosses === 'none' ? 0 : this.totalLosses;
            this.totalLosses += ratio;
            this.lossCount = this.lossCount === 'none' ? 0 : this.lossCount;
            this.lossCount++;

            // Update grade counts
            if (this.gradeCounts[item.grade] === 'none') {
                this.gradeCounts[item.grade] = 0;
            }
            this.gradeCounts[item.grade]++;

            this.finalizeData();
        },
        setAge: function(age) {
            this.age = age;
            this.displaySummary();
        },
        finalizeData: function() {
            if (this.lossCount !== 'none') {
                this.averageLoss = this.totalLosses / this.lossCount;
                this.displaySummary();
            }
        },
        displaySummary: function() {
            const container = document.getElementById('statistics');
            if (!container) {
                console.error("Summary container not found");
                return;
            }
            container.innerHTML = `
                <table style="width: 1024px; text-align: center;">
                    <tr>
                        <th style="width: 70px;">Patient<br>Age</th>
                        <th style="width: 70px;">Max<br>Loss</th>
                        <th style="width: 70px;">Avg<br>Loss</th>
                        <th style="width: 70px;">Total<br>Teeth</th>
                        <th style="width: 70px;">Grade A<br>Num</th>
                        <th style="width: 70px;">Grade B<br>Num</th>
                        <th style="width: 70px;">Grade C<br>Num</th>
                        <th style="width: 200px;">Smoking<br>State</th>
                        <th style="width: 200px;">Diabetes<br>State</th>
                    </tr>
                    <tr style="font-size: 16px; height: 45px;">
                        <td>${this.age}</td>
                        <td>${this.maxLoss !== 'none' ? this.maxLoss.toFixed(2) + "%" : this.maxLoss}</td>
                        <td>${this.averageLoss !== 'none' ? this.averageLoss.toFixed(2) + "%" : this.averageLoss}</td>
                        <td>${this.lossCount !== 'none' ? this.lossCount : this.lossCount}</td>
                        <td>${this.gradeCounts.A !== 'none' ? this.gradeCounts.A : this.gradeCounts.A}</td>
                        <td>${this.gradeCounts.B !== 'none' ? this.gradeCounts.B : this.gradeCounts.B}</td>
                        <td>${this.gradeCounts.C !== 'none' ? this.gradeCounts.C : this.gradeCounts.C}</td>
                        <td>
                            <select class="risk-factors" id="select-smoking" onchange="updateValue('smoking', this.value)">
                                <option value="None">none</option>
                                <option value="Non-smoker">Non-smoker</option>
                                <option value="Smoker＜10 cigarettes/day">Smoker＜10 cigarettes/day</option>
                                <option value="Smoker≥10 cigarettes/day">Smoker≥10 cigarettes/day</option>
                            </select>
                        </td>
                        <td>
                            <select class="risk-factors" id="select-diabetes" onchange="updateValue('diabetes', this.value)">
                                <option value="None">none</option>
                                <option value="Normoglycemic / <br>no diagnosis of diabetes">Normoglycemic / no diagnosis of diabetes</option>
                                <option value="HbAlc＜7.0% in patients with diabetes">HbAlc＜7.0% in patients with diabetes</option>
                                <option value="HbAlc≥7.0% in patients with diabetes">HbAlc≥7.0% in patients with diabetes</option>
                            </selct>
                        </td>
                    </tr>
                </table>
                `;
            this.drawPieChart();
        },
        drawPieChart: function() {
            const ctx = document.getElementById('gradeChart').getContext('2d');
            const data = {
                labels: ['A', 'B', 'C'],
                datasets: [{
                    label: 'Grade Counts',
                    data: [
                        this.gradeCounts.A !== 'none' ? this.gradeCounts.A : 0,
                        this.gradeCounts.B !== 'none' ? this.gradeCounts.B : 0,
                        this.gradeCounts.C !== 'none' ? this.gradeCounts.C : 0
                    ],
                    backgroundColor: ['rgb(67, 235, 229)', ' rgb(132, 92, 243)', 'rgb(217, 63, 231)'],
                    hoverOffset: 4,
                    borderWidth: 0 // 파이 차트 섹션 테두리 선 제거
                }]
            };
            const options = {
                responsive: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            pointStyle: 'rect',
                            color: '#dcdcdc',
                            font: {
                                size: 12,
                                family: 'Arial',
                                style: 'normal',
                            },
                            padding: 9 // 라벨 사이 간격
                        }
                    },
                    // 차트 위에 결과 표시
                    datalabels: {
                        color: 'black',
                        font: {
                            size: 12,
                        },
                        formatter: (value, ctx) => {
                            // 0이 아닌 데이터만 표시
                            if (value > 0) {
                                const label = ctx.chart.data.labels[ctx.dataIndex];
                                return `${value}`;
                            } else {
                                return '';
                            }
                        }
                    }
                },
                layout: {
                    padding: {
                        bottom: 10,
                        left: 2,
                        right: 2,
                    }
                },
            };
            if (this.chartInstance) {
                this.chartInstance.data = data;
                this.chartInstance.options = options;
                this.chartInstance.update();
            } else {
                this.chartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: data,
                    options: options,
                    plugins: [ChartDataLabels] // datalabels 플러그인을 추가
                });
            }
        }

    };

    // dentalData 객체 초기화 함수 추가
    function resetDentalData() {
        dentalData.maxLoss = 'none';
        dentalData.minLoss = 'none';
        dentalData.totalLosses = 'none';
        dentalData.lossCount = 'none';
        dentalData.gradeCounts = { A: 'none', B: 'none', C: 'none' };
        dentalData.age = 'none';
        dentalData.averageLoss = 'none';
    }
    
    // 페이지 로드 시 요약 정보를 초기화합니다.
    document.addEventListener('DOMContentLoaded', function() {
        dentalData.displaySummary();

    });
</script>

<!-----------------------------------서버에서 가져온 위치 좌표를 점으로 표시----------------------------------->
<script>
    function addLocationPoint(x, y, m, typ) {
        const container = document.getElementById('result-draw-layer');
        const point = document.createElement('div');
        point.style.position = 'absolute';
        // point.style.top = `${y-2.5}px`;
        // point.style.left = `${x-2}px`; 

        point.style.top = `${m[1] - 2.5}px`; // 중간점의 y 좌표를 사용
        point.style.left = `${m[0] - 2}px`; // 중간점의 x 좌표를 사용

        point.style.width = '5px';
        point.style.height = '5px';
        point.style.backgroundColor = 'rgba(255, 255, 255, 0.5)';
        point.style.borderRadius = '50%'; // 원형 점
        point.style.zIndex = '10'; // 캔버스 위에 보이도록
        
        // 데이터 속성 추가
        if (typ === 'up') {
            point.setAttribute('data-cej-type', 'up');
            // point.style.top = `${y+15}px`;
        } else if (typ === 'low') {
            point.setAttribute('data-cej-type', 'low');
            // point.style.top = `${y-15}px`;
        }
        
        container.appendChild(point);
    }

    // -----------------------------------서버에서 받은 등급과 비율을 각각의 infoBox안에 표시-----------------------------------
    function addGradeRatio(x, y, grade, ratio, cejType) {
        const container = document.getElementById('result-draw-layer');
        const infoBox = document.createElement('div');
        infoBox.classList.add('info-box');
        
        let boxY;

        if (cejType === 'up') {
            boxY = -1; // 상단 박스 y 좌표
        } else {
            boxY = container.offsetHeight - 20; // 하단 박스 y 좌표
        }

        infoBox.style.left = `${x}px`;
        infoBox.style.top = `${boxY}px`;

        // 등급과 비율 정보를 데이터 속성으로 추가
        infoBox.setAttribute('data-grade', grade);
        infoBox.setAttribute('data-ratio', ratio);

        console.log(`Added infoBox with ratio: ${ratio}`); // 로그 추가
        console.log(`Added infoBox with grade: ${grade}`); // 로그 추가

        container.appendChild(infoBox);
        infoBox.innerHTML = `<div class="div-v"">
                                <strong style="font-size: 22px;">${grade}</strong>
                                <div class="div-h" style="align-items: end;">
                                    <strong style="font-size: 14px;">${ratio}</strong>
                                    <strong style="font-size: 12px;">%</strong>
                                </div>
                            </div>`;
    }

    // -----------------------------------result-draw-layer 에 그려진 infoBox에 인덱스를 부여함 좌->우-----------------------------------
    function orderInfoBoxes() {
        const infoBoxes = document.querySelectorAll('.info-box');
        const topInfoBoxes = Array.from(infoBoxes).filter(box => {
            // 상단에 위치한 infoBox만
            return box.offsetTop < 0;
        });
        const bottomInfoBoxes = Array.from(infoBoxes).filter(box => {
            // 상단에 위치한 infoBox만
            return box.offsetTop > 0;
        });

        // x 좌표를 기준으로 정렬
        topInfoBoxes.sort((a, b) => a.offsetLeft - b.offsetLeft);
        bottomInfoBoxes.sort((a, b) => a.offsetLeft - b.offsetLeft);
    }


    function calculateColor(start, end, ratio, divide) {
        // 비율에 따른 색상 값 계산 (선형 보간) 각 등급이 20% 차이니 20으로 나눔
        return Math.round(start + (end - start) * (ratio / divide));
    }

    // -----------------------------------비율에 따른 색상 스타일 적용-----------------------------------
    function DetermineColorBasedOnRatio(box, grade, ratio, maxRatio) {
        // // 비율에 따른 색상 계산
        // let startColor, endColor;
        // let divide = 0;
        
        // if (grade === 'A') {
        //     startColor = { r: 243, g: 255, b: 255 };
        //     endColor = { r: 14, g: 219, b: 212 };
        //     divide = 40
        // } else if (grade === 'B') {
        //     startColor = { r: 220, g: 207, b: 255 };
        //     endColor = { r: 78, g: 23, b: 229 };
        //     divide = 40
        // } else if (grade === 'C') {
        //     startColor = { r: 251, g: 207, b: 255 };
        //     endColor = { r: 193, g: 10, b: 209 };
        //     divide = 40
        // } else {
        //     // 기본값이나 예외 처리
        //     box.style.backgroundColor = 'rgb(0, 0, 0)'; // 흰색
        //     return;
        // }

        // let ratioColor = {
        //     r: calculateColor(startColor.r, endColor.r, ratio, divide),
        //     g: calculateColor(startColor.g, endColor.g, ratio, divide),
        //     b: calculateColor(startColor.b, endColor.b, ratio, divide)
        // };

        // box.style.backgroundColor = `rgb(${ratioColor.r}, ${ratioColor.g}, ${ratioColor.b})`;
        
        // 최대 비율을 가진 박스에 특별한 스타일 적용
        if (ratio === maxRatio) {
            box.classList.add('max-ratio-box');
        } else {
            box.classList.remove('max-ratio-box');
        }

        // if (grade === 'A') {
        //     box.style.backgroundColor = 'rgb(67, 235, 229)';
        // } else if (grade === 'B') {
        //     box.style.backgroundColor = 'rgb(132, 92, 243)'; 
        // } else if (grade === 'C') {
        //     box.style.backgroundColor = 'rgb(217, 63, 231)'; 
        // } else {
        //     box.style.backgroundColor = 'rgb(255, 255, 255)'; 
        //     return;
        // }

        if (grade === 'A') {
            box.style.backgroundColor = 'rgb(67, 235, 229)';
            box.style.color = 'black';
        } else if (grade === 'B') {
            box.style.backgroundColor = 'rgb(132, 92, 243)';
            box.style.color = 'black';
        } else if (grade === 'C') {
            box.style.backgroundColor = 'rgb(217, 63, 231)';
            box.style.color = 'black';
        } else {
            box.style.borderColor = 'rgba(182, 238, 255, 0.9)';
            box.style.color = '#dcdcdc';
            return;
        }
        // 박스 높이 최소 40, 최대 200px
        box.style.height = `${Math.max(45, Math.min((ratio * 2) + 40, 200))}px`;
    }





    // -------------------- infoBox의 내용만 순서대로 info-box2에 복사하고 top-infobox-container에 넣음 --------------------
    let maxRatio = 0;  // 전역 변수로 최대 비율 저장
    function cloneAndArrangeBoxes() {
        const topInfoBoxContainer = document.querySelector('div[id="top-infobox-container"]');
        const bottomInfoBoxContainer = document.querySelector('div[id="bottom-infobox-container"]');

        const infoBoxes = document.querySelectorAll('.info-box');

        // 상단 infoBox의 배열을 만들고 x 좌표에 따라 정렬
        const topInfoBoxes = Array.from(infoBoxes).filter(box => box.offsetTop < 0);
        topInfoBoxes.sort((a, b) => a.offsetLeft - b.offsetLeft);
        
        const bottomInfoBoxes = Array.from(infoBoxes).filter(box => box.offsetTop > 0);
        bottomInfoBoxes.sort((a, b) => a.offsetLeft - b.offsetLeft);

        maxRatio = 0; // 최대 비율 초기화
        // 모든 박스를 검사하여 최대 비율 찾기
        infoBoxes.forEach(box => {
            const ratio = parseFloat(box.getAttribute('data-ratio'));
            if (ratio > maxRatio) {
                maxRatio = ratio;
            }
        });

        topInfoBoxes.forEach((box, index) => {
            // 데이터 속성에서 등급과 비율 정보 읽기
            const grade = box.getAttribute('data-grade');
            const ratio = parseFloat(box.getAttribute('data-ratio'));

            const topNewDiv = document.createElement('div');
            topNewDiv.innerHTML = box.innerHTML;
            topNewDiv.className = 'info-box2';

            topNewDiv.setAttribute('data-ratio', ratio);  // 추가
            topNewDiv.setAttribute('data-grade', grade);  // 추가
            console.log('Creating top info-box2 with ratio:', ratio, grade);  // 생성 시 로그 추가
            
            topInfoBoxContainer.appendChild(topNewDiv);

            DetermineColorBasedOnRatio(topNewDiv, grade, ratio, maxRatio);
        });

        bottomInfoBoxes.forEach((box, index) => {
            // 데이터 속성에서 등급과 비율 정보 읽기
            const grade = box.getAttribute('data-grade');
            const ratio = parseFloat(box.getAttribute('data-ratio'));
            
            const bottomNewDiv = document.createElement('div');
            bottomNewDiv.innerHTML = box.innerHTML;
            bottomNewDiv.className = 'info-box3';

            bottomNewDiv.setAttribute('data-ratio', ratio);  // 추가
            bottomNewDiv.setAttribute('data-grade', grade);  // 추가
            console.log('Creating bottom info-box3 with ratio:', ratio, grade);  // 생성 시 로그 추가
            bottomInfoBoxContainer.appendChild(bottomNewDiv);

            DetermineColorBasedOnRatio(bottomNewDiv, grade, ratio, maxRatio);
        });

        // 새로 생성된 박스들에 클릭 이벤트 추가
        document.querySelectorAll('.info-box2, .info-box3').forEach(function(box) {
            box.addEventListener('click', function() {
                const ratio = parseFloat(this.getAttribute('data-ratio'));
                const grade = this.getAttribute('data-grade'); // grade 값 가져오기
            });
        });
    }

    // --------------------------------포인트와 박스2, 3를 선으로 매칭함. 여기선 x좌표만을 기준으로 가장 가까운 포인트와 박스를 매칭해 이어줌 --------------------------------
    function drawLineFromPointToBox() {
        const canvas = document.getElementById('canvas-layer');
        const ctx = canvas.getContext('2d');

        const topPoints = Array.from(document.querySelectorAll('div[data-cej-type="up"]')).sort((a, b) => parseFloat(a.style.left) - parseFloat(b.style.left));
        const bottomPoints = Array.from(document.querySelectorAll('div[data-cej-type="low"]')).sort((a, b) => parseFloat(a.style.left) - parseFloat(b.style.left));

        const topInfoBoxes = Array.from(document.querySelectorAll('.info-box2')).sort((a, b) => {
            const rectA = a.getBoundingClientRect();
            const rectB = b.getBoundingClientRect();
            return rectA.left - rectB.left;
        });

        const bottomInfoBoxes = Array.from(document.querySelectorAll('.info-box3')).sort((a, b) => {
            const rectA = a.getBoundingClientRect();
            const rectB = b.getBoundingClientRect();
            return rectA.left - rectB.left;
        });

        function drawDoubleLine(fromX, fromY, toX, toY, outerColor, innerColor, outerWidth, innerWidth) {
            // 외부 선 그리기 (검은색)
            ctx.beginPath();
            ctx.moveTo(fromX, fromY);
            ctx.lineTo(toX, toY);
            ctx.strokeStyle = outerColor;
            ctx.lineWidth = outerWidth;
            ctx.stroke();

            // 내부 선 그리기 (흰색)
            ctx.beginPath();
            ctx.moveTo(fromX, fromY);
            ctx.lineTo(toX, toY);
            ctx.strokeStyle = innerColor;
            ctx.lineWidth = innerWidth;
            ctx.stroke();
        }

        topPoints.forEach((point, index) => {
            const pointX = parseFloat(point.style.left) + 2.5;
            const pointY = parseFloat(point.style.top) + 2.5;

            if (topInfoBoxes[index]) {
                const box = topInfoBoxes[index];
                const rect = box.getBoundingClientRect();
                const canvasRect = canvas.getBoundingClientRect();
                const boxCenterX = rect.left + rect.width / 2 - canvasRect.left;
                // 아랫변 중간점으로 Y 좌표 수정
                const boxCenterY = rect.top + rect.height - canvasRect.top;

                // 이중선 그리기 (검은색 외곽선 + 흰색 내부선)
                drawDoubleLine(pointX, pointY, boxCenterX, boxCenterY, 'black', 'white', 4, 2);
            }
        });

        bottomPoints.forEach((point, index) => {
            const pointX = parseFloat(point.style.left) + 2.5;
            const pointY = parseFloat(point.style.top) + 2.5;

            if (bottomInfoBoxes[index]) {
                const box = bottomInfoBoxes[index];
                const rect = box.getBoundingClientRect();
                const canvasRect = canvas.getBoundingClientRect();
                const boxCenterX = rect.left + rect.width / 2 - canvasRect.left;

                // 윗변 중간점으로 Y 좌표 수정
                const boxCenterY = rect.top - canvasRect.top;

                // 이중선 그리기 (검은색 외곽선 + 흰색 내부선)
                drawDoubleLine(pointX, pointY, boxCenterX, boxCenterY, 'black', 'white', 4, 2);
            }
        });
    }

    // ------------------------------ 선택 이미지 미리보기 로직 ------------------------------
    document.getElementById('imgfile').addEventListener('change', function(event) {
        var file = event.target.files[0];
        if (file && file.type.match('image.*')) { // 파일이 이미지인지 확인
            var reader = new FileReader();
            
            reader.onload = function(e) {
                var previewContainer = document.getElementById('preview-container');
                // 미리보기 이미지가 이미 있다면 제거
                previewContainer.innerHTML = ''; 
                
                // 새 이미지 미리보기 생성
                var img = document.createElement('img');
                img.src = e.target.result;
                img.style.width = '100%'; // 미리보기 크기 조절, 필요에 따라 조정
                img.style.height = 'auto';
                
                previewContainer.appendChild(img); // 미리보기 컨테이너에 이미지 추가
            };
            
            reader.readAsDataURL(file); // 파일 읽기
        }
    });

    // ------------------------------ 로딩 애니매이션 생성 ------------------------------
    function createLoader() {
        const container = document.getElementById('loader-box');
        if (!container) {
            console.error('Container element not found');
            return;
        }
        const loader = document.createElement('div');
        loader.classList.add('loader');

        const text = document.createElement('div');
        text.classList.add('text');
        text.textContent = "Loading...";
        loader.appendChild(text);

        for (let i = 1; i <= 3; i++) {
            const loadInner = document.createElement('div');
            loadInner.classList.add('load-inner', `load-${i === 1 ? 'one' : i === 2 ? 'two' : 'three'}`);
            loader.appendChild(loadInner);
        }

        container.appendChild(loader);
    }

// ------------------------------ 크롭된 이미지를 표시하는 함수 ------------------------------
    function displayCroppedImage(base64Image) {
        const imgElement = document.getElementById('cropped-image');
        imgElement.src = 'data:image/jpeg;base64,' + base64Image;
        imgElement.style.display = 'block'; // 이미지 표시
        imgElement.style.border = 'solid 1px rgb(55, 88, 107)';
    }

// ------------------------------ Annotation 이미지를 표시하는 함수 ------------------------------
    function displayMaskImage(base64Image) {
        const imgContainer = document.getElementById('mask-image-container');
        imgContainer.innerHTML = ''; // 기존 이미지 제거
        const imgElement = document.createElement('img');
        imgElement.src = 'data:image/png;base64,' + base64Image;
        imgElement.style.width = '1024px';  // 이미지 폭 설정
        imgElement.style.height = '512px';  // 이미지 높이 설정
        imgContainer.appendChild(imgElement);
        imgContainer.style.display = 'none';
    }
    function displayPblImage(base64Image) {
        const imgContainer = document.getElementById('pbl-image-container');
        imgContainer.innerHTML = ''; // 기존 이미지 제거
        const imgElement = document.createElement('img');
        imgElement.src = 'data:image/png;base64,' + base64Image;
        imgElement.style.width = '1024px';  // 이미지 폭 설정
        imgElement.style.height = '512px';  // 이미지 높이 설정
        imgContainer.appendChild(imgElement);
        imgContainer.style.display = 'none';
    }
    function displayCejUpImage(base64Image) {
        const imgContainer = document.getElementById('cej-up-image-container');
        imgContainer.innerHTML = ''; // 기존 이미지 제거
        const imgElement = document.createElement('img');
        imgElement.src = 'data:image/png;base64,' + base64Image;
        imgElement.style.width = '1024px';  // 이미지 폭 설정
        imgElement.style.height = '512px';  // 이미지 높이 설정
        imgContainer.appendChild(imgElement);
        imgContainer.style.display = 'none';
    }
    function displayCejLowImage(base64Image) {
        const imgContainer = document.getElementById('cej-low-image-container');
        imgContainer.innerHTML = ''; // 기존 이미지 제거
        const imgElement = document.createElement('img');
        imgElement.src = 'data:image/png;base64,' + base64Image;
        imgElement.style.width = '1024px';  // 이미지 폭 설정
        imgElement.style.height = '512px';  // 이미지 높이 설정
        imgContainer.appendChild(imgElement);
        imgContainer.style.display = 'none';
    }
    function displayTeethImage(base64Image) {
        const imgContainer = document.getElementById('teeth-image-container');
        imgContainer.innerHTML = ''; // 기존 이미지 제거
        const imgElement = document.createElement('img');
        imgElement.src = 'data:image/png;base64,' + base64Image;
        imgElement.style.width = '1024px';  // 이미지 폭 설정
        imgElement.style.height = '512px';  // 이미지 높이 설정
        imgContainer.appendChild(imgElement);
        imgContainer.style.display = 'none';
    }
    function displayAxisImage(base64Image) {
        const imgContainer = document.getElementById('axis-image-container');
        imgContainer.innerHTML = ''; // 기존 이미지 제거
        const imgElement = document.createElement('img');
        imgElement.src = 'data:image/png;base64,' + base64Image;
        imgElement.style.width = '1024px';  // 이미지 폭 설정
        imgElement.style.height = '512px';  // 이미지 높이 설정
        imgContainer.appendChild(imgElement);
        imgContainer.style.display = 'none';
    }
// ---------------------------------- 업로드 시 작동 함수 ----------------------------------
    function uploadImage() {
        var ageInput = document.getElementById('ageInput').value; // 나이 입력값 가져오기
        var file_input = document.getElementById('imgfile');

        // 나이와 이미지 모두 입력되었는지 확인
        if (!file_input.files[0] || ageInput === "" || parseInt(ageInput) < 1) {
            alert("Please enter a valid image and age.");
            return; // 함수 실행 중지
        }

        resetDentalData(); // dentalData 객체 초기화

        dentalData.setAge(parseInt(ageInput)); // 나이 데이터를 dentalData 객체에 설정

        var form_data = new FormData();
        var uploadButton = document.querySelector("button[onclick='uploadImage()']"); // 업로드 버튼 선택
        uploadButton.disabled = true; // 업로드 시작 시 버튼 비활성화

        var canvas = document.getElementById('canvas-layer');
        var ctx = canvas.getContext('2d');

        var topInfoBoxContainer = document.getElementById('top-infobox-container');
        var bottomInfoBoxContainer = document.getElementById('bottom-infobox-container');
        var resultDrawLayer = document.getElementById('result-draw-layer');
        var loaderBox = document.getElementById('loader-box');

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        topInfoBoxContainer.innerHTML = '';
        bottomInfoBoxContainer.innerHTML = '';

        var maskImgContainer = document.getElementById('mask-image-container');
        var pblImgContainer = document.getElementById('pbl-image-container');
        var cejUpImgContainer = document.getElementById('cej-up-image-container');
        var cejLowImgContainer = document.getElementById('cej-low-image-container');
        var teethImgContainer = document.getElementById('teeth-image-container');
        var axisImgContainer = document.getElementById('axis-image-container');

        maskImgContainer.innerHTML = '';
        pblImgContainer.innerHTML = '';
        cejUpImgContainer.innerHTML = '';
        cejLowImgContainer.innerHTML = '';
        teethImgContainer.innerHTML = '';
        axisImgContainer.innerHTML = '';
        
        document.getElementById("toggle-mask-checkbox").checked = false;
        document.getElementById("toggle-pbl-checkbox").checked = false;
        document.getElementById("toggle-cej-up-checkbox").checked = false;
        document.getElementById("toggle-cej-low-checkbox").checked = false;
        document.getElementById("toggle-teeth-checkbox").checked = false;
        document.getElementById("toggle-axis-checkbox").checked = false;

        // resultDrawLayer 내의 canvas를 제외한 모든 요소를 제거
        Array.from(resultDrawLayer.childNodes).forEach(child => {
            if (child.id !== 'canvas-layer') {
                resultDrawLayer.removeChild(child);
            }
        });

        createLoader();
        
        form_data.append('imgfile', file_input.files[0]);
        form_data.append('age', ageInput); // 나이 데이터를 FormData에 추가

        fetch('{% url "diagnosis_single" %}', {
            method: 'POST',
            body: form_data,
            headers: {
                'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value
            }
        })
        .then(response => response.json())
        .then(data => {

            // 서버로부터 받은 이미지(Base64 문자열)를 이미지 객체로 로드
            var img = new Image();
            img.src = 'data:image/jpeg;base64,' + data.graded_data[0].encoded_image_copy;

            save_img = 'data:image/jpeg;base64,' + data.graded_data[0].encoded_image;

            img.onload = function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
     
                // 치아 정보(등급과 스코어) 표시 로직
                data.graded_data.forEach(item => {
                    let textX, textY, textM, typ;
                    if (item.cej_type === 'up') {
                        textX = item.start_coordinate[0];
                        textY = item.start_coordinate[1];

                        let endX = item.end_coordinate[0];
                        let endY = item.end_coordinate[1];
                        textM = [(textX + endX) / 2, (textY + endY) / 2]; // 중간점 계산
                        typ = "up"
                        
                    } else {
                        textX = item.end_coordinate[0];
                        textY = item.end_coordinate[1];

                        let startX = item.start_coordinate[0];
                        let startY = item.start_coordinate[1];
                        textM = [(textX + startX) / 2, (textY + startY) / 2]; // 중간점 계산
                        typ = "low"
                    }

                    addLocationPoint(textX, textY, textM, typ);
                    addGradeRatio(textX, textY, item.grade, item.ratio, item.cej_type);

                    dentalData.updateMetrics(item); // 요약 데이터 업데이트
                });

                dentalData.finalizeData(); // ratio 편균 계산
                dentalData.displaySummary(); // 요약 데이터 표시

                orderInfoBoxes();
                cloneAndArrangeBoxes();
                drawLineFromPointToBox();
                
                document.getElementById('bottom-line').style.display = 'none';
                document.getElementById('statistics').style.display = 'flex';
                document.getElementById('sg-results-summary').style.display = 'flex';
                document.getElementById('sg-results-control').style.display = 'flex';
                document.getElementById('tagging-btn').style.display = 'flex';
            };
            
            if (data.additional_data.cropped_image) {
                displayCroppedImage(data.additional_data.cropped_image);
            }
            if (data.additional_data.mask_image) {
                displayMaskImage(data.additional_data.mask_image);  
            }
            if (data.additional_data.pbl_img) {
                displayPblImage(data.additional_data.pbl_img);
            }
            if (data.additional_data.cej_up_img) {
                displayCejUpImage(data.additional_data.cej_up_img);
            }
            if (data.additional_data.cej_low_img) {
                displayCejLowImage(data.additional_data.cej_low_img);
            }
            if (data.additional_data.teeth_img) {
                displayTeethImage(data.additional_data.teeth_img); 
            }
            if (data.additional_data.axis_img) {
                displayAxisImage(data.additional_data.axis_img); 
            }

            uploadButton.disabled = false; // 서버 응답 후 버튼 다시 활성화
            loaderBox.innerHTML = '';
        })

        .catch(error => {
            loaderBox.innerHTML = '';
            console.error('Error:', error);
            alert('Error');
            location.reload(); // 현재 페이지 새로고침

        });
    }
</script>

<script>
    // Mask 이미지 토글 
    document.getElementById('toggle-mask-checkbox').addEventListener('change', function() {
        const maskContainer = document.getElementById('mask-image-container');
        if (this.checked) {
            maskContainer.style.display = 'block';  
        } else {
            maskContainer.style.display = 'none';  
        }
    });
    // PBL 이미지 토글 
    document.getElementById('toggle-pbl-checkbox').addEventListener('change', function() {
        const pblContainer = document.getElementById('pbl-image-container');
        if (this.checked) {
            pblContainer.style.display = 'block'; 
        } else {
            pblContainer.style.display = 'none';  
        }
    });
    // CEJ_UP 이미지 토글 
    document.getElementById('toggle-cej-up-checkbox').addEventListener('change', function() {
        const cejUpContainer = document.getElementById('cej-up-image-container');
        if (this.checked) {
            cejUpContainer.style.display = 'block';  
        } else {
            cejUpContainer.style.display = 'none';  
        }
    });
    // CEJ_LOW 이미지 토글
    document.getElementById('toggle-cej-low-checkbox').addEventListener('change', function() {
        const cejLowContainer = document.getElementById('cej-low-image-container');
        if (this.checked) {
            cejLowContainer.style.display = 'block';  
        } else {
            cejLowContainer.style.display = 'none';  
        }
    });
    // Teeth 이미지 토글
    document.getElementById('toggle-teeth-checkbox').addEventListener('change', function() {
        const teethContainer = document.getElementById('teeth-image-container');
        if (this.checked) {
            teethContainer.style.display = 'block';  
        } else {
            teethContainer.style.display = 'none';  
        }
    });
    // Axis 이미지 토글
    document.getElementById('toggle-axis-checkbox').addEventListener('change', function() {
        const axisContainer = document.getElementById('axis-image-container');
        if (this.checked) {
            axisContainer.style.display = 'block';  
        } else {
            axisContainer.style.display = 'none';  
        }
    });
    // All 이미지 토글
    document.getElementById('toggle-all-checkbox').addEventListener('change', function() {
        const allCheckboxes = document.querySelectorAll('#toggle-mask-checkbox, #toggle-pbl-checkbox, #toggle-cej-up-checkbox, #toggle-cej-low-checkbox, #toggle-teeth-checkbox, #toggle-axis-checkbox');
        const maskContainer = document.getElementById('mask-image-container');
        const pblContainer = document.getElementById('pbl-image-container');
        const cejUpContainer = document.getElementById('cej-up-image-container');
        const cejLowContainer = document.getElementById('cej-low-image-container');
        const teethContainer = document.getElementById('teeth-image-container');
        const axisContainer = document.getElementById('axis-image-container');
        
        const isChecked = this.checked;
        
        // 모든 체크박스를 toggle-all-checkbox 상태와 동일하게 설정
        allCheckboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
        });
        if (isChecked) {
            maskContainer.style.display = 'block';
            pblContainer.style.display = 'block';
            cejUpContainer.style.display = 'block';
            cejLowContainer.style.display = 'block';
            teethContainer.style.display = 'block';
            axisContainer.style.display = 'block';
        } else {
            maskContainer.style.display = 'none';
            pblContainer.style.display = 'none';
            cejUpContainer.style.display = 'none';
            cejLowContainer.style.display = 'none';
            teethContainer.style.display = 'none';
            axisContainer.style.display = 'none';
        }
    });
</script>
{% endblock %}
